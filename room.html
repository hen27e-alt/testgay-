<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Room</title>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="firebase.js"></script>

<style>
body{
background:#0b0516;
color:white;
font-family:system-ui;
text-align:center;
padding:20px;
}
button{
padding:10px;
margin:5px;
border:none;
border-radius:8px;
background:#7f13ec;
color:white;
font-weight:bold;
cursor:pointer;
}
</style>
</head>

<body>

<h3>קוד חדר: <span id="roomCode"></span></h3>

<div id="waiting">
<h4>ממתינים לשחקנים...</h4>
<ul id="players"></ul>
<button id="startBtn" onclick="startGame()" style="display:none;">התחל משחק</button>
</div>

<div id="game" style="display:none;">
<h3>⏱ זמן: <span id="timer"></span></h3>
</div>

<script>

const params=new URLSearchParams(window.location.search);
const roomId=params.get("room");

if(!roomId){
window.location.href="index.html";
}

document.getElementById("roomCode").innerText=roomId;

const myId=localStorage.getItem("deviceId");
const roomRef=firebase.database().ref("rooms/"+roomId);

let isHost=false;
let interval;

roomRef.on("value",snap=>{

const room=snap.val();
if(!room) return;

isHost=(room.host===myId);

if(room.status==="waiting"){

document.getElementById("waiting").style.display="block";
document.getElementById("game").style.display="none";

const list=document.getElementById("players");
list.innerHTML="";

Object.values(room.players||{}).forEach(p=>{
const li=document.createElement("li");
li.innerText=p.name+" ("+p.score+")";
list.appendChild(li);
});

if(isHost){
document.getElementById("startBtn").style.display="inline-block";
}

}

if(room.status==="playing"){
document.getElementById("waiting").style.display="none";
document.getElementById("game").style.display="block";
document.getElementById("timer").innerText=room.timer;

if(room.timer===0){
clearInterval(interval);
}

}

});

function startGame(){
roomRef.update({
status:"playing",
timer:10
});
startTimer();
}

function startTimer(){

clearInterval(interval);

interval=setInterval(()=>{

roomRef.child("timer").transaction(current=>{
if(current>0) return current-1;
return current;
});

},1000);

}

</script>

</body>
</html>
